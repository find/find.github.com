<!doctype HTML>
<html>
<head>
<meta name="viewport" content="width=1100, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<title>Anti OCR</title>
<style>
.container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: stretch;
  min-width: 300px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 10px;
}
#execute {
  height: 3em;
  font-weight: bold;
  font-family: sans-serif;
  font-size: 2em;
  margin: 20px;
}
#download {
  margin: 0;
  padding: 0.5em;
  font-size: 1.5em;
  width: 100%;
}
#view {
  margin: 0;
  padding: 0.5em;
  font-size: 1em;
  width: 100%;
}
#input {
  font-family: serif;
  font-size: 1.5em;
  resize: vertical;
}
canvas {
  border: none;
  padding: 0 auto;
  margin: 0;
}
#output-container {
  border: 1px solid black;
  display: block;
  padding: 0;
  margin: 0 auto;
  width: 800px;
  height: 600px;
  resize: both;
  overflow: auto;
}
#config {
  background: #f7f7f7;
  border: 2px solid #aaa;
}
.parm > span {
  margin: 0 0.5em;
}
.parm > .label {
  display: inline-block;
  width: 5em;
}
.label {
  font-size: 2em;
}
</style>
<script>
const SERIF_FONT = 'Source Han Serif, 思源宋体, STSong, FangSong, serif';
const SANS_SERIF_FONT = 'Source Han Sans, 思源黑体, Microsoft YaHei, sans-serif';
let PADDING = 20;
let YSPACE = 19; // y-direction spacing between characters
let XSPACE = 24; // x-direction spacing between characters
let ENSPACE = YSPACE/2; // ' ' spacing
let NORMAL_FONT = `16px ${SERIF_FONT}`;
let BOLD_FONT = `bold 16px ${SANS_SERIF_FONT}`;
let ITALIC_FONT = `italic 16px ${SANS_SERIF_FONT}`;
let TITLE_FONT = `bolder 22px ${SANS_SERIF_FONT}`;
let JITTER = 0;

var $ = id=>document.getElementById(id);
function doTheJob() {
  const canvas = $('output');
  const W = canvas.width;
  const H = canvas.height;
  let ctx = canvas.getContext('2d');
  const invert = $('invert').checked;
  const clearcolor = invert?'black':'white';
  const fillcolor  = invert?'white':'black';
  ctx.fillStyle = clearcolor;
  ctx.fillRect(0,0,W,H);

  const nf = NORMAL_FONT;
  NORMAL_FONT = `bold ${nf}`;
  const fontsize=$('font-size').value;
  const glitch = $('glitch').checked;
  if (glitch) {
    if (invert)
      ctx.strokeStyle='#333333';
    else
      ctx.strokeStyle='#cccccc';

    for (let i=0; i<10; ++i) {
      let x = Math.random()*W, y = Math.random()*H;
      let c = Math.random()*Math.min(W,H)*0.5+20;
      ctx.lineWidth=18+Math.round(Math.random()*18);
      ctx.beginPath();
      ctx.arc(x,y,c,0,2*Math.PI);
      ctx.stroke();
      ctx.closePath();
    }
    doRender(ctx, [-fontsize/10,-fontsize/12], 'cyan');
    doRender(ctx, [fontsize/10,fontsize/12], 'fuchsia');
  }
  doRender(ctx, [0,0], fillcolor);
  NORMAL_FONT = nf;

  if (JITTER>0) {
    let img = ctx.getImageData(0,0,W,H);
    let out = ctx.createImageData(W,H);
    for (let y1=0; y1<H;) {
      let y2 = y1+20+Math.floor(Math.random()*120);
      if (y2>H) y2=H;
      let shift = [1,1,1];
      if (glitch)
        shift = [Math.random()*0.2+0.9, Math.random()*0.2+0.9, Math.random()*0.2+0.9];
      let xoffset = Math.floor((Math.random()*fontsize/2-fontsize/4)*JITTER*30);
      for (let y=y1; y<y2; ++y) {
        for (let x=0; x<W; ++x) {
          let i=y*W*4+(x+xoffset)%W*4;
          let j=y*W*4+x*4;
          out.data[j  ] = img.data[i  ]*shift[0];
          out.data[j+1] = img.data[i+1]*shift[1];
          out.data[j+2] = img.data[i+2]*shift[2];
          out.data[j+3] = 255;
        }
      }
      y1 = y2;
    }
    ctx.putImageData(out, 0,0);
  }
}
function doRender(ctx, offset, color) {
  const canvas = $('output');
  const W = canvas.width;
  const H = canvas.height;
  

  let msg = $('input').value
    .replaceAll('“', '﹃')
    .replaceAll('”', '﹄')
    .replaceAll('‘', '﹁')
    .replaceAll('’', '﹂')
    .replaceAll('《', '︽')
    .replaceAll('》', '︾')
    .replaceAll('{', '︷')
    .replaceAll('}', '︸')
    .replaceAll('[', '︻')
    .replaceAll(']', '︼')
    .replaceAll('【', '︻')
    .replaceAll('】', '︼')
    .replaceAll('(', '︵')
    .replaceAll(')', '︶')
    .replaceAll('…', '⋮')
    .replaceAll('—', '︱');
  ctx.font = NORMAL_FONT;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillStyle = color;

  let charsize = ctx.measureText('啊');
  let x=W-PADDING-charsize.width/2+offset[0], y=PADDING+offset[1];
  let firstline = true;
  let bold = false;
  let italic = false;
  for (let line of msg.split('\n')) {
    let title = line.match(/^#\s*(.+)$/);
    let yspace = YSPACE;
    if (title) {
      ctx.font = TITLE_FONT;
      line = title[1]
      if (!firstline) {
        x-=XSPACE;
      }
      yspace = YSPACE*1.4; // larger spacing
    } else {
      ctx.font = NORMAL_FONT;
      bold = false; // new line clears style
    }
    yspace -= JITTER*YSPACE*0.1;
    for (let i=0; i<line.length; ++i) {
      //ctx.fillStyle='#a33';
      //ctx.fillRect(x-2,y-2,4,4); // debug
      ctx.fillStyle=color;
      let c = line[i];
      let rand = ()=>Math.random();
      let jitter = [(rand()*XSPACE/4-XSPACE/8)*JITTER, (rand()*YSPACE/4-YSPACE/8)*JITTER];
      if (!title && c=='\\') {
        if (i<line.length && line[i+1]=='*') {
          ++i;
          c = '*';
        }
        if (i<line.length && line[i+1]=='_') {
          ++i;
          c = '_';
        }
      } else if (c=='*') {
        bold = !bold;
        if (bold)
          ctx.font = BOLD_FONT;
        else
          ctx.font = NORMAL_FONT;
        continue;
      } else if (c=='_') {
        italic = !italic;
        if (italic)
          ctx.font = ITALIC_FONT;
        else
          ctx.font = NORMAL_FONT;
        continue;
      }
      if (c.match(/[\p{Script=Latin}0-9_@\-$%'"]/iu)) {
        let s = c;
        for (++i; i<line.length; ++i) {
          if (line[i].match(/[\p{Script=Latin}0-9.,:;_\-\\/!@#$%^&*'" ]/iu)) {
            s += line[i];
          }
          else
            break;
        }
        --i;

        if (s.length>1) {
          let met = ctx.measureText(s);
          let tw = met.width;
          if (y+tw > H-PADDING) {
            y = PADDING;
            x -= XSPACE;
          }
          ctx.save();
          ctx.textAlign='left';
          ctx.textBaseline='middle';
          ctx.translate(x+jitter[0],y+jitter[1]);
          ctx.rotate(Math.PI/2);
          ctx.fillText(s,0,0);
          ctx.restore();
          y += tw-yspace+ENSPACE/2;
        } else {
          ctx.fillText(c, x+jitter[0], y+jitter[1]);
        }
      } else if (c==' ') {
        y -= yspace-ENSPACE;
      } else {
        let kerning=[0,0];
        if (c.match(/[，。、]/u)) {
          kerning = [charsize.width/3, -yspace/2];
        }
        ctx.save();
        ctx.translate(x+kerning[0]+jitter[0], y+kerning[1]+jitter[1]);
        let rot = (rand()*Math.PI/6-Math.PI/12)*JITTER;
        ctx.rotate(rot);
        let scale = 1+(rand()-0.5)*0.4*JITTER; 
        ctx.scale(scale, scale);
        ctx.fillText(c, 0,0);
        ctx.restore();
        y -= (1-scale)*yspace;
      }
      y += yspace;
      if (y+yspace>=H-PADDING) {
        y = PADDING;
        x -= XSPACE;
      }
    }
    y = PADDING;
    x -= XSPACE;
    if (title) // extra space
      x -= XSPACE/2;
    firstline = false;
  }
}

function updateFonts() {
  let v=$('font-size').value
  $('font-size-disp').innerHTML=v
  let dpr = window.devicePixelRatio || 1.0;
  v = Number(v)*dpr;
  YSPACE = Math.ceil(v*1.15);
  XSPACE = Math.ceil(v*1.5);
  ENSPACE = Math.ceil(v*1.15*0.5);
  PADDING = v*1.4;
  NORMAL_FONT = `${Math.ceil(v)}px ${SERIF_FONT}`;
  ITALIC_FONT = `italic ${Math.ceil(v)}px ${SERIF_FONT}`;
  BOLD_FONT = `bold ${Math.ceil(v)}px ${SANS_SERIF_FONT}`;
  TITLE_FONT = `bolder ${Math.ceil(v*1.375)}px ${SANS_SERIF_FONT}`;
}
function onResize() {
  let canvas = $('output');
  let scale = window.devicePixelRatio || 1;
  let container = $('output-container');
  //if (canvas.width != container.clientWidth || canvas.height != container.clientHeight) {
    canvas.width = (container.clientWidth-2)*scale;
    canvas.height = (container.clientHeight-4)*scale;
    canvas.style.width = `${container.clientWidth-2}px`;
    canvas.style.height = `${container.clientHeight-4}px`;
    updateFonts();
    doTheJob();
  //}
}

//window.addEventListener('resize', onResize);
window.addEventListener('load', function() {
  onResize();
  $('execute').onclick=doTheJob;
  $('input').oninput=doTheJob;
  new ResizeObserver(onResize).observe($('output-container'));
  $('font-size').oninput=()=>{
    updateFonts();
    doTheJob();
  }
  $('jitter').oninput=()=>{
    let v=$('jitter').value;
    $('jitter-disp').innerHTML = `${v}%`;
    JITTER = Number(v)/100.0;
    doTheJob();
  }
  $('glitch').onchange=doTheJob;
  $('invert').onchange=doTheJob;
  $('download').onclick=()=>{
    let img=$('output').toDataURL('image/png').replace('image/png', 'image/octet-stream');
    let now=new Date();
    $('download-anchor').setAttribute('download', `${now.getFullYear()}-${now.getMonth()}-${now.getDay()}-${now.getHours()}-${now.getMinutes()}.png`)
    $('download-anchor').setAttribute('href', img);
  }
  $('view').onclick=()=>{
    let dataurl=$('output').toDataURL('image/png');
    let tab = window.open(dataurl);
    setTimeout(() => {
      let image = new Image();
      image.src = dataurl;
      tab.document.write(image.outerHTML);
    }, 0);
  }
});
</script>
</head>

<body>
<div class="container">
<p class="label">Output:</p>
<div id="config">
  <div class="parm"><span class="label">Font Size:</span><input id="font-size" style="width:50%" type="range" min="10" max="80" value="16" class="slider"/><span class="label" id="font-size-disp">16</span></div>
  <div class="parm"><span class="label">Jitter:</span><input id="jitter" style="width:50%" type="range" min="0" max="200" value="0" class="slider"/><span class="label" id="jitter-disp">0%</span></div>
  <div class="parm"><span class="label">Glitch:</span><input id="glitch" type="checkbox"/></div>
  <div class="parm"><span class="label">Invert:</span><input id="invert" type="checkbox"/></div>
</div>
</div>

<div id="output-container">
  <canvas id="output"></canvas>
</div>

<div class="container">
<a id="download-anchor" download="image.png">
  <button id="download">Download Image</button>
</a>
<button id="view">View In New Tab</button>

<p class="label">Input:</p>
<textarea id="input" rows="12">
</textarea>
<button id="execute">Convert</button>

</div>
</body>

</html>
